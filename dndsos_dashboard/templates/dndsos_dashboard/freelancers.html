{% extends 'dndsos_dashboard/base.html' %}
{% load static %}
{% load i18n %}

{% load leaflet_tags %}
{% leaflet_css %}
{% leaflet_js %}

{% block content %}
{% get_current_language as lang %}

{% include 'dndsos_dashboard/partials/_message-sent-modal.html' %}
<link rel="stylesheet" href="//unpkg.com/leaflet/dist/leaflet.css"/>
<script src="//unpkg.com/leaflet/dist/leaflet.js"></script>
<style>
    /* Reference: http://www.javascriptkit.com/dhtmltutors/cssmediaqueries2.shtml */
    @media screen and (min-width: 1024px){
        .freelancers-map {
            max-width: 1000px; 
            height: 500px; 
            margin-left: 2rem;
            z-index: 1;
        }

        .total-ratings {
            background-color: gold;
            position: absolute;
            top: 0;
            left: 0;
            height: 25px;
            z-index: 1;
        }
        .panel-body .stars img {
            position: absolute;
            top: 0;
            left: 0;
            width: 80%;
            z-index: 2;
        }
    }
    @media screen and (max-device-width: 360px) and (orientation: portrait){
        .freelancers-map {
            max-width: 400px; 
            height: 500px; 
            margin-left: 0rem;
            z-index: 1;
        }

        .total-ratings {
            background-color: gold;
            position: absolute;
            top: 0;
            left: 0;
            height: 45px;
            z-index: 1;
        }
        .panel-body .stars img {
            position: absolute;
            top: 0;
            left: 0;
            width: 80%;
            z-index: 2;
        }

        .row .stars {
            margin-bottom: 1rem;
        }
      }

    @media screen and (max-device-width: 740px) and (orientation: landscape){
        .freelancers-map {
            max-width: 400px; 
            height: 500px; 
            margin-left: 1rem;
            z-index: 1;
        }
      }
</style>

<section role="main" class="content-body" {% if lang == 'he' %} dir='rtl' align='right' {% else %} style="text-align: left;"{% endif %}>
    <header class="page-header">
        <h2>{% trans 'Couriers' %}</h2>
    
        <div class="right-wrapper pull-right">
            <ol class="breadcrumbs">
                <li>
                    <a href="{% url 'dndsos_dashboard:b-dashboard' b_id=user.pk %}">
                        <i class="fa fa-home"></i>
                    </a>
                </li>
                <li><span>{% trans 'Couriers' %}</span></li>
            </ol>
    
            <a class="sidebar-right-toggle" data-open="sidebar-right"><i class=""></i></a>
        </div>
    </header>

    <!-- start: page -->
        <div class="col-md-10 col-lg-10" {% if lang == 'he' %} dir='rtl' align='right' {% else %} style="text-align: left;"{% endif %}>
            <div class="tabs">
                <ul class="nav nav-tabs tabs-primary">
                    <li class="active">
                        <a href="#freelancers_map" data-toggle="tab">{% blocktrans %}Couriers Map{% endblocktrans %}</a>
                    </li>
                    <li class="">
                        <a href="#select_tab" data-toggle="tab">{% blocktrans %}Select Couriers{% endblocktrans %}</a>
                    </li>
                    <li >
                        <a href="#manage_tab" data-toggle="tab">{% blocktrans %}Your Couriers{% endblocktrans %}</a>
                    </li>
                </ul>
                <div class="tab-content">

                    <!-- Freelancers Map tab -->
                    <div id="freelancers_map" class="tab-pane active">

                        <form action="" method="POST" enctype="multipart/form-data" id="b_select_freelancers" name="select_freelancers">
                            {% csrf_token %}
                            <div class="row" >
                                <div class="col-md-4">
                                    <h4>{% trans 'Active couriers around your business' %}</h4>
                                    <p>{% trans 'There' %}  {% if total_freelancers > 1 %}  {% trans 'are' %} {% else %} {% trans 'is' %} {% endif %}{{ total_freelancers }} {% trans 'active Couriers' %}.</p>
                                    <!-- <button type="submit" class="btn btn-warning" name="sort_by_city" type="button">Show all!</button> -->
                                </div>
                            </div>
    
                            <hr>
                
                            <div class="row">
                                <!-- Map -->
                                <div class="freelancers-map" id="m"></div>
                            </div>

                        </form>
                    </div> 
                    <!-- End Business freelancers tab -->
                    
                    <!-- Freelancers Tab -->
                    <div id="select_tab" class="tab-pane">
                        <form action="" method="POST" enctype="multipart/form-data" id="select_freelancers" name="select_freelancers">
                            {% csrf_token %}
                            <div class="row" >
                                <div class="col-md-4">
                                    <h4>{% trans 'Pick Available Couriers in range' %} {{ max_range }} {% trans 'km' %}</h4>
                                    <p>{% trans 'There' %}  {% if total_freelancers > 1 %}  {% trans 'are' %} {% else %} {% trans 'is' %} {% endif %}{{ total_freelancers }} {% trans 'Couriers available' %}.</p>
                                </div>
                                <div class="col-md-6">
                                    <div class="input-group mb-md">
                                        <label for="range_selector" style="margin-right: 2rem;">{% trans 'Range from couriers' %}</label>
                                        <select name="range" id="range_selector">
                                            <option value="1.0">--------</option>
                                            <option value="1.0">1 km</option>
                                            <option value="5.0">5 km</option>
                                            <option value="10.0">10 km</option>
                                            <option value="15.0">15 km</option>
                                            <option value="20.0">20 km</option>

                                        </select>
                                        <label for="vehicle_selector" style="margin: 2rem;">{% trans 'Filter by Vehicle' %} </label>
                                        <select name="vehicle" id="vehicle_selector">
                                            <option value="">--------------------</option>
                                            {% for vehicle in vehicles %}
                                            {% blocktrans %} <option value="{{ vehicle }}">{{ vehicle }}</option>{% endblocktrans %}
                                            {% endfor %}
                                        </select>
                                        <span class="input-group-btn left">
                                            <button type="submit" class="btn btn-success" name="filter" type="button">{% trans 'Filter' %}!</button>
                                        </span>
                                    </div>                    
                                </div>
                                <div class="col-md-2 left">
                                </div>
                            </div>
                            <hr>
                            <div class="row">
                                {% for freelancer in freelancers %}
                                    <div class="col-md-3">
										<section class="panel">
											<header class="panel-heading bg-primary">
												<div class="panel-heading-profile-picture">
													<img src="{{ freelancer.profile_pic.url }}">
												</div>
											</header>
											<div class="panel-body">
												<h4 class="text-semibold mt-sm">{{ freelancer.name }}</h4>
												<p>{% trans 'Short bio' %}: {{ freelancer.bio }} </p>
                                                <p>{% trans 'Vehicle' %}: {{ freelancer.vehicle }} </p>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <p>{% trans 'Average Rating' %}: </p>
                                                    </div>
                                                    <div class="col-md-6 stars">
                                                        <div class="total-ratings" style="width: calc(16% *  {{ freelancer.freelancer_total_rating }} "></div>
                                                        <img src="{% static 'assets/images/stars.png' %}" alt="" title="{{ freelancer.freelancer_total_rating }}">
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6"></div>
                                                    <div class="col-md-6">
                                                        <p><b>({{ freelancer.freelancer_total_rating }}/5)</b></p>
                                                    </div>
                                                </div>
                                                
												<hr class="solid short">

                                                <div class="row">
                                                    <!-- Request Freelancer Button -->
                                                    <div class="col-md-12 text-center" >

                                                        <!-- Select Freelancer modal -->
                                                        <a class="mb-xs mt-xs mr-xs btn btn-success" data-toggle="modal" data-target="#selectFreelancer_{{ freelancer.pk }}">{% trans 'Request Courier' %}</a>

                                                        <div class="modal fade" id="selectFreelancer_{{ freelancer.pk }}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                                                            <div class="modal-dialog">
                                                                <div class="modal-content">
                                                                    <div class="modal-header">
                                                                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">{% trans 'Close' %}</span></button>
                                                                        <h4 class="modal-title" id="myModalLabel">{% trans 'Which order would you like the freelancer for' %}?</h4>
                                                                    </div>
                                                                    <div class="modal-body form-group">
                                                                         <select class="form-control" name="open_orders" id="open_orders_{{ freelancer.pk }}">
                                                                             <option value="">---------</option>
                                                                             {% for order in orders %}
                                                                                <option value="{{ order.order_id  }}">{{ order.drop_off_address }}</option>
                                                                             {% endfor %}
                                                                         </select>
                                                                    </div>
                                                                    <div class="modal-footer">
                                                                        <button type="button" 
                                                                            id="freelancer_{{ freelancer.pk }}" 
                                                                            onclick="request_specific_freelancer('{{ freelancer.pk }}',false)" 
                                                                            class="btn btn-primary">{% trans 'Confirm' %}
                                                                        </button>
                                                                        <button type="button" class="btn btn-default" data-dismiss="modal">{% trans 'Cancel' %}</button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                </div>
											</div>
										</section>
                                    </div> 
                                {% endfor %}
                            </div>
                            </form>
                    </div>
                    <!-- End Freelancers tab -->

                    <!-- Business Freelancers tab -->
                    <div id="manage_tab" class="tab-pane ">

                        <form action="" method="POST" enctype="multipart/form-data" id="b_select_freelancers_form" name="select_freelancers">
                            {% csrf_token %}
                            <div class="row" >
                                <div class="col-md-4">
                                    <h4>{% trans 'Pick Available Couriers From Your Pool' %}</h4>
                                    <p>{% trans 'There' %}  {% if num_b_freelancers > 1 %}  {% trans 'are' %} {% else %} {% trans 'is' %} {% endif %}{{ num_b_freelancers }} {% trans 'Couriers in your pool' %}.</p>
                                    <!-- <button type="submit" class="btn btn-warning" name="sort_by_city" type="button">{% trans 'Show all' %}!</button> -->
                                </div>
                            </div>
                            <!-- <div class="row" style="margin-top: 1rem;">
                                <div class="col-md-3">
                                   <i class="fa fa-circle" style="color: #e36159;"></i><span> Means you need to pay them.</span>
                                </div>
                            </div> -->
 
                            <hr>
                
                            <div class="row">
                                {% for freelancer in b_freelancers %}
                                    <div class="col-md-3">
										<section class="panel">
                                            {% if freelancer.pk in freelancers_due_payment %}
											    <header class="panel-heading bg-secondary">
                                            {% else %}
											    <header class="panel-heading bg-primary">
                                            {% endif %}
                                            <div class="panel-heading-profile-picture">
                                                <img src="{{ freelancer.freelancer.profile_pic.url }}">
                                            </div>
											</header>
											<div class="panel-body">
												<h4 class="text-semibold mt-sm">{{ freelancer.employee.name }}</h4>
												<p>{% trans 'Email' %}: {{ freelancer.email }} </p>
												<p>{% trans 'Short bio' %}: {{ freelancer.freelancer.bio }} </p>
												<p>{% trans 'City' %}: {{ freelancer.freelancer.city }} </p>
                                                <p>{% trans 'Vehicle' %}: {{ freelancer.freelancer.vehicle }} </p>
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <p>{% trans 'Average Rating' %}: </p>
                                                    </div>
                                                    <div class="col-md-6 stars">
                                                        <div class="total-ratings" style="width: calc(16% *  {{ freelancer.freelancer.freelancer_total_rating }} "></div>
                                                        <img src="{% static 'assets/images/stars.png' %}" alt="" title="{{ freelancer.freelancer.freelancer_total_rating }}">
                                                    </div>
                                                </div>
                                                <div class="row stars">
                                                    <div class="col-md-6"></div>
                                                    <div class="col-md-6">
                                                        <p><b>({{ freelancer.freelancer.freelancer_total_rating }}/5)</b></p>
                                                    </div>
                                                </div>

												<hr class="solid short">
                                               
                                                <div class="row">
                                                    <!-- Request Freelancer Button -->
                                                    <div class="col-md-12 text-center" >

                                                        <!-- Select Freelancer modal -->
                                                        <a class="mb-xs mt-xs mr-xs btn btn-success" data-toggle="modal" data-target="#b_selectFreelancer_{{ freelancer.pk }}">{% blocktrans %}Request Courier{% endblocktrans %}</a>

                                                        <div class="modal fade" id="b_selectFreelancer_{{ freelancer.pk }}" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                                                            <div class="modal-dialog">
                                                                <div class="modal-content">
                                                                    <div class="modal-header">
                                                                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">{% trans 'Close' %}</span></button>
                                                                        <h4 class="modal-title" id="myModalLabel">{% trans 'Which order would you like the courier for' %}?</h4>
                                                                    </div>
                                                                    <div class="modal-body form-group">
                                                                         <select class="form-control" name="open_orders" id="b_open_orders_{{ freelancer.pk }}">
                                                                             <option value="">---------</option>
                                                                             {% for order in orders %}
                                                                                <option value="{{ order.order_id  }}">{{ order.drop_off_address }}</option>
                                                                             {% endfor %}
                                                                         </select>
                                                                    </div>
                                                                    <div class="modal-footer">
                                                                        <button type="button" 
                                                                            id="b_freelancer_{{ freelancer.pk }}" 
                                                                            onclick="request_specific_freelancer('{{ freelancer.pk }}',true)" 
                                                                            class="btn btn-primary">{% trans 'Confirm' %}
                                                                        </button>
                                                                        <button type="button" class="btn btn-default" data-dismiss="modal">{% trans 'Cancel' %}</button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>

                                                </div>
                                                <hr>
                                                <h5> <button class="fa fa-plus btn btn-sm btn-primary" type="button" onclick="showReport('{{ freelancer.pk }}')"></button> {% trans 'Show Orders Completed' %}</h5> 
                                                <div class="table-responsive-sm" id="orders_report{{ freelancer.pk }}" style="display: none">
                                                    <table class="table table-striped table-borderless table-hover table-sm" style="width:100%">
                                                        <thead>
                                                            <th style="width: 50%">{% trans 'Date' %}</th>
                                                            <th style="width: 50%">{% trans 'Drop-off' %}</th>
                                                            <!-- <th style="width: 20%"></th> -->
                                                        </thead>
                                                            <tbody>
                                                                {% for order in completed_orders %}
                                                                    {% if order.freelancer.freelancer.pk == freelancer.freelancer.pk %}
                                                                        <tr>
                                                                            <td>{{ order.created }}</td>
                                                                            <td>{{ order.drop_off_address }}</td>
                                                                            <!-- <td style='text-align:center'>
                                                                                include './partials/_payment-modal.html' with order=order
                                                                            </td> -->
                                                                        </tr>
                                                                    {% endif %}
                                                                {% endfor %}
                                                            </tbody>
                                                    </table>    
                                                </div>
											</div>
										</section>
                                    </div> 
                                {% endfor %}
                            </div>

                        </form>
                    </div> 
                    <!-- End Business freelancers tab -->
                    </div>
                </div>
            </div>
        </div>
    <!-- end: page -->
</section>
{% endblock content %}

{% block js %}
{% include 'dndsos_dashboard/partials/_freelancer-request-sent-modal.html' %}
<script>
    showReport = function (user_id) {
        let x = document.getElementById(`orders_report${user_id}`);
        if (x.style.display === "none") {
          x.style.display = "block";
        } else {
          x.style.display = "none";
        }
      }

</script>
<script>
    request_specific_freelancer = function(freelancer_id, managed){
        
        if (managed){
            order_id = document.getElementById(`b_open_orders_${freelancer_id}`).value;
        } else {
            order_id = document.getElementById(`open_orders_${freelancer_id}`).value;
        }

        if (order_id == ''){
            alert('Please pick a order or cancel message.')
            return false
        }
        //console.log(`SELECTED: ${order_id}`);
        $(`#selectFreelancer_${freelancer_id}`).modal('hide')
        $(`#b_selectFreelancer_${freelancer_id}`).modal('hide')

        businessSocket.send(JSON.stringify({
            'type': 'direct.message', 
            'data': {
                'event': 'Specific Freelancer',
                'order_id': order_id,                
                'business': user_id,
                'requested_freelancer': freelancer_id,
                'status': 'RE_REQUESTED'
            }
        }));


        $("#requestFreelancerSent").modal("show");

    }
</script>

<script>
    toggleSection = function() {
        var div = document.getElementById('qrContent');
        if (div.style.display !== 'none') {
            div.style.display = 'none';
        }
        else {
            div.style.display = 'block';
        }
    };
    
</script>

<script type="text/javascript">
    {% if platform == 'mac' %}
        var m = L.map('m').setView([{{ user.business.location.x }}, {{ user.business.location.y }}], 13); 
    {% else %}
        var m = L.map('m').setView([{{ user.business.location.y }}, {{ user.business.location.x }}], 13); 
    {% endif %}
    
    L.tileLayer('//{s}.tile.osm.org/{z}/{x}/{y}.png').addTo(m);
    const century21icon = L.icon({
        iconUrl: "{% static 'assets/images/scooter-icon.png' %}",
        iconSize: [30, 30]
        });

    {% for e in freelancers %}
        {% if platform == 'mac' %}
            L.marker([{{ e.location.x }}, {{ e.location.y }}], {icon: century21icon}).addTo(m).bindPopup('{{e.name}}');
        {% else %}
            L.marker([{{ e.location.y }}, {{ e.location.x }}], {icon: century21icon}).addTo(m).bindPopup('{{e.name}}');
        {% endif %}
    {% endfor %}
</script>

{% endblock js %}
